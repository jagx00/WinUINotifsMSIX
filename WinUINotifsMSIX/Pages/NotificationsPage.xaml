<Page
  x:Class="WinUINotifsMSIX.Pages.NotificationsPage"
  x:Name="RootPage"
  xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
  xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
  xmlns:local="using:WinUINotifsMSIX"
  xmlns:logmodels="using:JAGLog.Models"
  xmlns:converters="using:WinUINotifsMSIX.Converters"
  xmlns:vm="using:WinUINotifsMSIX.ViewModels">
	<Page.Resources>
		<converters:SelectionBackgroundConverter x:Key="SelectionBackgroundConverter"/>
		<converters:NullToCollapsedConverter x:Key="NullToCollapsedConverter"/>
		<converters:SleepBoolToTextConverter x:Key="SleepBoolToTextConverter"/>
		<converters:LogLevelToBrushConverter x:Key="LogLevelToBrushConverter"/>
	</Page.Resources>
	
	<Grid>
		<Grid.RowDefinitions>
			<RowDefinition Height="Auto"/>
			<!-- Button row -->
			<RowDefinition Height="Auto"/>
			<!-- ListView and details panel -->
			<RowDefinition Height="*"/>
			<RowDefinition Height="Auto"/>
		</Grid.RowDefinitions>
		<Grid.ColumnDefinitions>
			<ColumnDefinition Width="2*" />
			<ColumnDefinition Width="*" />
		</Grid.ColumnDefinitions>
		<!-- Clear Selection Button -->
		<StackPanel Grid.Row="0" Grid.ColumnSpan="2"
					Orientation="Horizontal"
					Margin="12"
					HorizontalAlignment="Left"
					VerticalAlignment="Center"
					Spacing="12">
			<Button Content="Clear Selection"
					Click="ClearSelection_Click"/>
			<TextBlock Text="{Binding SelectedNotification.ID}"
					   IsTextSelectionEnabled="True"
					   FontWeight="SemiBold"
					   Foreground="DarkSlateBlue"/>
			<TextBlock x:Name="tbkAppVersionHdr"  Text="App Version: " />
			<TextBlock x:Name="tbkAppVersion" 
					   Text="{x:Bind Mode=OneWay, Path=ViewModel.AppVersion}" IsTextSelectionEnabled="True"
					   FontWeight="Bold"/>
			<TextBlock Text="Notifications.Count: " />
			<TextBlock Text="{Binding Notifications.Count, Mode=OneWay}" FontWeight="Bold"    />
			<TextBlock Text="Keep Awake State:" VerticalAlignment="Center"/>
			<ToggleSwitch IsOn="{Binding PowerStateMonitor.IsSleepBlocked, Mode=TwoWay}"
						  OffContent="Allow Sleep"
						  OnContent="Prevent Sleep"/>
			<Button Content="Run Log Housekeeping"
					Command="{Binding TriggerHousekeepingCommand}"
					Margin="12"/>
		</StackPanel>
		
		<StackPanel Grid.Row="1" Grid.ColumnSpan="2"
				   Orientation="Horizontal"
				   Background="Red"
				   Visibility="{x:Bind ViewModel.MatchEventVisibility, Mode=OneWay}"
				   Margin="12"
				   HorizontalAlignment="Stretch">
			<Grid ColumnDefinitions="Auto,Auto,*,Auto">
				<ComboBox Grid.Column="0"
						  Width="292"
						  ItemsSource="{Binding AFLMatches}"
						  SelectedItem="{Binding SelectedAFLMatch, Mode=TwoWay}"
						  DisplayMemberPath="MatchName"/>

				<TextBlock Grid.Column="1"
						   Text="{x:Bind ViewModel.SelectedAFLMatch.ID, Mode=OneWay, TargetNullValue='', FallbackValue=''}"
						   Margin="8,0"/>

				<TextBox Grid.Column="2"
						 Text="{x:Bind ViewModel.MatchEventText, Mode=TwoWay, TargetNullValue='', FallbackValue=''}"
						 TextWrapping="Wrap"
						 FontSize="8"
						 Margin="8,0"/>

				<Button Grid.Column="3"
						Content="WriteMatchEvent"
						Command="{x:Bind ViewModel.WriteMatchEventCommand}"
						Margin="8,0"/>
			</Grid>		
		</StackPanel>

		<ListView Grid.Row="2" Grid.Column="0"
				  x:Name="NotificationsList"
				  ItemsSource="{Binding Notifications}"
				  SelectedItem="{Binding SelectedNotification, Mode=TwoWay}">
			<ListView.ItemTemplate>
				<DataTemplate x:DataType="vm:NotificationItem">
					<StackPanel Margin="8"
								Background="{Binding ElementName=NotificationsList, Path=SelectedItem, Converter={StaticResource SelectionBackgroundConverter}, ConverterParameter={Binding}}">
						<StackPanel Orientation="Horizontal" Spacing="12">
							<TextBlock Text="{x:Bind ID}" FontWeight="Bold"/>
							<TextBlock Text="{x:Bind Source}" Foreground="Gray"/>
							<TextBlock Text="{x:Bind CreationTime}" Foreground="Gray"/>
							<TextBlock Text="{x:Bind Title}" FontWeight="Bold"/>
							<NumberBox
									   FontSize="14"
									   FontWeight="SemiBold"
									   Foreground="DarkSlateBlue"
									   Background="LightGray"
									   BorderBrush="SlateGray"
									   BorderThickness="0"
									   SpinButtonPlacementMode="Inline"
									   Value="{x:Bind Visibility, Mode=TwoWay}"
									   ValueChanged="VisibilityBox_ValueChanged"
									   PreviewKeyDown="VisibilityBox_PreviewKeyDown"
									   Width="90"
									   Height="32"
									   Minimum="0"
									   Maximum="9"/>
							<Button Content="Delete"
								Command="{Binding DataContext.DeleteNotificationCommand, ElementName=RootPage}"
								CommandParameter="{x:Bind}"
								HorizontalAlignment="Right"
								Height="32"
								 />
						</StackPanel>
						<TextBlock Text="{x:Bind Body}" IsTextSelectionEnabled="True"
								   TextWrapping="Wrap"/>
					</StackPanel>
				</DataTemplate>
			</ListView.ItemTemplate>
		</ListView>
		<!-- Details Panel -->
		<Border Grid.Row="2" Grid.Column="1"
				Background="LightGray"
				Padding="12"
				Visibility="{Binding SelectedNotification, Converter={StaticResource NullToCollapsedConverter}}">
			<Border.Transitions>
				<TransitionCollection>
					<EntranceThemeTransition FromHorizontalOffset="100"/>
				</TransitionCollection>
			</Border.Transitions>

			<ContentControl Content="{Binding SelectedNotification}">
				<ContentControl.ContentTemplate>
					<DataTemplate x:DataType="vm:NotificationItem">
						<StackPanel Padding="12" Background="LightGray">
							<TextBlock Text="Details" FontSize="18" FontWeight="Bold" Margin="0,0,0,12"/>
							<TextBlock Text="ID:" FontWeight="SemiBold"/>
							<TextBlock Text="{x:Bind ID}" Margin="0,0,0,8"/>

							<TextBlock Text="Source:" FontWeight="SemiBold"/>
							<TextBlock Text="{x:Bind Source}" Margin="0,0,0,8"/>

							<TextBlock Text="Created:" FontWeight="SemiBold"/>
							<TextBlock Text="{x:Bind CreationTime}" Margin="0,0,0,8"/>

							<TextBlock Text="Title:" FontWeight="SemiBold"/>
							<TextBlock Text="{x:Bind Title}" Margin="0,0,0,8"/>

							<TextBlock Text="Body:" FontWeight="SemiBold"/>
							<TextBlock Text="{x:Bind Body}" IsTextSelectionEnabled="True"
									   TextWrapping="Wrap" Margin="0,0,0,8"/>
							<TextBlock Text="Visibility:" FontWeight="SemiBold"/>
							<NumberBox Value="{x:Bind Visibility, Mode=TwoWay}"
									   Minimum="0" Maximum="9"
									   Width="90" Height="32"/>
						</StackPanel>
					</DataTemplate>
				</ContentControl.ContentTemplate>
			</ContentControl>
		</Border>
		<Expander Grid.Row="3" Grid.ColumnSpan="2" 
				  IsExpanded="{x:Bind ViewModel.IsDebugPanelExpanded, Mode=TwoWay}"  
				  Margin="12"
				  VerticalAlignment="Bottom">
			<Expander.Header>
				<Grid ColumnDefinitions="*,Auto">
					<TextBlock Grid.Column="0"
							   Text="{x:Bind ViewModel.DebugLogHeader, Mode=OneWay}"
							   FontWeight="Bold"/>
					<ComboBox Grid.Column="1"
							  ItemsSource="{x:Bind ViewModel.AvailableApplications, Mode=OneWay}"
							  SelectedItem="{x:Bind ViewModel.SelectedApplication, Mode=TwoWay}"
							  Header="Application Filter"
							  Width="160"/>
				</Grid>
			</Expander.Header>
			
			<ListView x:Name="LogsListView"
					  ItemsSource="{x:Bind ViewModel.RecentLogs, Mode=OneWay}"
					  MaxHeight="500"
					  ScrollViewer.VerticalScrollBarVisibility="Auto">

				<ListView.ItemContainerStyle>
					<Style TargetType="ListViewItem">
						<Setter Property="Padding" Value="1"/>
						<Setter Property="Margin" Value="0"/>
						<Setter Property="MinHeight" Value="0"/>
						<Setter Property="HorizontalContentAlignment" Value="Stretch"/>
					</Style>
				</ListView.ItemContainerStyle>
				<ListView.ItemTemplate>
					<DataTemplate x:DataType="logmodels:SeriLog">
						<Grid>
							<Grid.RowDefinitions>
								<RowDefinition Height="Auto"/>
								<RowDefinition Height="Auto"/>
							</Grid.RowDefinitions>
							<Grid.ColumnDefinitions>
								<ColumnDefinition Width="155"/>
								<ColumnDefinition Width="90"/>
								<ColumnDefinition Width="*"/>
								<!-- Remaining space -->
							</Grid.ColumnDefinitions>
							<TextBlock Grid.Row="0" Grid.Column="0" Text="{x:Bind FormattedTimeStamp}" FontWeight="SemiBold"/>
							<TextBlock Grid.Row="0" Grid.Column="1"
									   Text="{x:Bind Level}"
									   Foreground="{Binding Level, Converter={StaticResource LogLevelToBrushConverter}}"
									   Margin="8,0,0,0"
									   VerticalAlignment="Center"/>
							<TextBlock Grid.Row="0" Grid.Column="2" Text="{x:Bind MethodName}" FontWeight="SemiBold"/>
							<TextBlock Grid.Row="1" Grid.ColumnSpan="3" Text="{x:Bind Message}" TextWrapping="Wrap"/>
						</Grid>
					</DataTemplate>
				</ListView.ItemTemplate>
			</ListView>
		</Expander>
	</Grid>
</Page>